"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const database_1 = require("./models/database");
const express = require("express");
const path = require("path");
const bodyParser = require("body-parser");
const cookieParser = require("cookie-parser");
const configs_1 = require("./configs");
const uuid_1 = require("uuid");
const user_model_1 = require("./models/user-model");
const private_executor_model_1 = require("./models/private_executor-model");
const execution_district_model_1 = require("./models/execution_district-model");
async function getLoggedUser(req) {
    if (req.signedCookies[configs_1.cookieName] == undefined)
        return;
    return user_model_1.User.findOne(JSON.parse(req.signedCookies[configs_1.cookieName]).login);
}
const app = express();
app.set('view engine', 'ejs');
app.use(cookieParser());
app.use(bodyParser.urlencoded({ extended: true, limit: 3000000 }));
app.use(bodyParser.json({ limit: 3000000 }));
app.use(bodyParser.text({ limit: 30000000 }));
app.use(express.static(path.join(__dirname, 'static')));
app.get('/', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    const role = (loggedUser == undefined) ? 0 : loggedUser.role;
    res.render('pages/main', {
        role
    });
});
app.get('/login', (req, res) => {
    res.render('pages/login');
});
app.get('/priv-exec/list', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/registrator/list', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/event-journal', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/priv-exec/new', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/priv-exec/edit', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/registrator/new', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/registrator/edit', async (req, res) => {
    const loggedUser = await getLoggedUser(req);
    if (loggedUser == undefined)
        return res.redirect('/error/permission-denied');
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.get('/error/permission-denied', async (req, res) => {
    //res.sendFile(path.join(__dirname,'public/index.html'));
});
app.post('/api/auth/login', async (req, res) => {
    const { login, password } = req.body;
    const userData = await user_model_1.User.findOne(login);
    if (userData.pwd_hash === password && userData.is_active === true) {
        res.cookie(configs_1.cookieName, JSON.stringify({ login, password }), configs_1.cookieOptions);
        res.status(200).send();
    }
    else {
        res.status(400).send();
    }
});
app.post('/api/auth/logout', async (req, res) => {
    res.clearCookie(configs_1.cookieName, configs_1.cookieOptions);
    res.status(200).send();
});
app.post('/api/user', async (req, res) => {
    const { fullname, additional_data } = req.body;
    const identificationData = {
        login: uuid_1.v1(),
        password: uuid_1.v4()
    };
    if (await user_model_1.User.findOne({ fullname }) == undefined) {
        const user = new user_model_1.User();
        user.login = identificationData.login;
        user.pwd_hash = identificationData.password;
        user.fullname = fullname;
        user.role = 1;
        user.date_registration = (new Date()).toISOString();
        user.is_active = true;
        user.additional_data = additional_data;
        await user.save();
        res.json(identificationData);
    }
    else {
        res.status(400).send();
    }
});
app.post('/api/user/:login/res_id', async (req, res) => {
    const user = await user_model_1.User.findOne(req.params.login);
    if (user == undefined) {
        return res.status(400).send();
    }
    user.login = uuid_1.v1();
    user.pwd_hash = uuid_1.v4();
    await user.save();
    res.status(200).send();
});
app.put('/api/user/:login', async (req, res) => {
    const { fullname, additional_data, is_active } = req.body;
    const user = await user_model_1.User.findOne(req.params.login);
    if (user == undefined) {
        return res.status(400).send();
    }
    if (fullname != undefined)
        user.fullname = fullname;
    if (is_active != undefined)
        user.is_active = is_active;
    if (additional_data != undefined)
        user.additional_data = additional_data;
    await user.save();
    res.status(200).send();
});
app.delete('/api/user/:login', async (req, res) => {
    await user_model_1.User.remove(req.params.login);
    res.status(200).send();
});
app.post('/api/priv-exec', async (req, res) => {
    const { fullname, district_id, certificate_num, rec_certif_on, office_addr, started_out_on } = req.body;
    const user_login = JSON.parse(req.signedCookies[configs_1.cookieName]).login;
    if (await private_executor_model_1.PrivateExecutor.findOne({ fullname }) == undefined) {
        const privExec = new private_executor_model_1.PrivateExecutor();
        privExec.fullname = fullname;
        privExec.user = await user_model_1.User.findOne(user_login);
        privExec.district = await execution_district_model_1.ExecutionDistrict.findOne(district_id);
        privExec.is_active = true;
        privExec.created_on = (new Date()).toISOString();
        privExec.certificate_num = certificate_num;
        privExec.rec_certif_on = rec_certif_on;
        privExec.office_addr = office_addr;
        privExec.started_out_on = started_out_on;
        await privExec.save();
        res.status(200).send();
    }
    else {
        res.status(400).send();
    }
});
app.put('/api/priv-exec/:id', async (req, res) => {
    const { fullname, district_id, certificate_num, rec_certif_on, office_addr, started_out_on, is_active } = req.body;
    const privExec = await private_executor_model_1.PrivateExecutor.findOne(req.params.id);
    if (privExec == undefined) {
        return res.status(400).send();
    }
    if (fullname != undefined)
        privExec.fullname = fullname;
    if (district_id != undefined)
        privExec.district = await execution_district_model_1.ExecutionDistrict.findOne(district_id);
    if (certificate_num != undefined)
        privExec.certificate_num = certificate_num;
    if (rec_certif_on != undefined)
        privExec.rec_certif_on = rec_certif_on;
    if (office_addr != undefined)
        privExec.office_addr = office_addr;
    if (started_out_on != undefined)
        privExec.started_out_on = started_out_on;
    if (is_active != undefined)
        privExec.is_active = is_active;
    await privExec.save();
    res.status(200).send();
});
app.delete('/api/priv-exec/:id', async (req, res) => {
    await private_executor_model_1.PrivateExecutor.remove(req.params.id);
    res.status(200).send();
});
app.use((err, req, resp, next) => {
    console.log(err);
    resp.status(500).send('ERROR');
});
process.on('SIGINT', async () => (await database_1.default).close().then(() => process.exit()));
(async function () {
    await (await database_1.default).synchronize();
    app.listen(process.env.PORT || 5000, () => {
        console.log("Started server!");
    });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxnREFBa0Q7QUFDbEQsbUNBQW1DO0FBQ25DLDZCQUE2QjtBQUM3QiwwQ0FBMEM7QUFDMUMsOENBQThDO0FBRTlDLHVDQUFzRDtBQUN0RCwrQkFBa0Q7QUFFbEQsb0RBQTJDO0FBQzNDLDRFQUFrRTtBQUNsRSxnRkFBc0U7QUFHdEUsS0FBSyxVQUFVLGFBQWEsQ0FBQyxHQUFvQjtJQUNoRCxJQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsb0JBQVUsQ0FBQyxJQUFJLFNBQVM7UUFDNUMsT0FBTztJQUVSLE9BQU8saUJBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLG9CQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3RFLENBQUM7QUFFRCxNQUFNLEdBQUcsR0FBd0IsT0FBTyxFQUFFLENBQUM7QUFFM0MsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDOUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQ3hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNuRSxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzdDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFFOUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFD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RyxDQUFDLENBQUMsR0FBVSxFQUFFLEdBQW9CLEVBQUUsSUFBc0IsRUFBRSxJQUFjLEVBQUMsRUFBRTtJQUNuRixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2hDLENBQUMsQ0FBQyxDQUFDO0FBRUgsT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sa0JBQWlCLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUU5RixDQUFDLEtBQUs7SUFDTCxNQUFNLENBQUMsTUFBTSxrQkFBaUIsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRTlDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDLENBQUMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvbm5lY3Rpb25Qcm9taXNlIGZyb20gJy4vbW9kZWxzL2RhdGFiYXNlJztcbmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBjb29raWVQYXJzZXIgZnJvbSBcImNvb2tpZS1wYXJzZXJcIjtcblxuaW1wb3J0IHsgY29va2llT3B0aW9ucywgY29va2llTmFtZSB9IGZyb20gXCIuL2NvbmZpZ3NcIjtcbmltcG9ydCB7IHYxIGFzIHV1aWRWMSwgdjQgYXMgdXVpZFY0IH0gZnJvbSBcInV1aWRcIjtcblxuaW1wb3J0IHsgVXNlciB9IGZyb20gXCIuL21vZGVscy91c2VyLW1vZGVsXCI7XG5pbXBvcnQgeyBQcml2YXRlRXhlY3V0b3IgfSBmcm9tIFwiLi9tb2RlbHMvcHJpdmF0ZV9leGVjdXRvci1tb2RlbFwiO1xuaW1wb3J0IHsgRXhlY3V0aW9uRGlzdHJpY3QgfSBmcm9tIFwiLi9tb2RlbHMvZXhlY3V0aW9uX2Rpc3RyaWN0LW1vZGVsXCI7XG5cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TG9nZ2VkVXNlcihyZXE6IGV4cHJlc3MuUmVxdWVzdCl7XG5cdGlmKHJlcS5zaWduZWRDb29raWVzW2Nvb2tpZU5hbWVdID09IHVuZGVmaW5lZClcblx0XHRyZXR1cm47XG5cblx0cmV0dXJuIFVzZXIuZmluZE9uZShKU09OLnBhcnNlKHJlcS5zaWduZWRDb29raWVzW2Nvb2tpZU5hbWVdKS5sb2dpbik7XG59XG5cbmNvbnN0IGFwcDogZXhwcmVzcy5BcHBsaWNhdGlvbiA9IGV4cHJlc3MoKTtcblxuYXBwLnNldCgndmlldyBlbmdpbmUnLCAnZWpzJyk7XG5hcHAudXNlKGNvb2tpZVBhcnNlcigpKTtcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUsIGxpbWl0OiAzMDAwMDAwIH0pKTtcbmFwcC51c2UoYm9keVBhcnNlci5qc29uKHsgbGltaXQ6IDMwMDAwMDAgfSkpO1xuYXBwLnVzZShib2R5UGFyc2VyLnRleHQoeyBsaW1pdDogMzAwMDAwMDAgfSkpO1xuXG5hcHAudXNlKGV4cHJlc3Muc3RhdGljKHBhdGguam9pbihfX2Rpcm5hbWUsJ3N0YXRpYycpKSk7XG5cblxuYXBwLmdldCgnLycsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG5cdGNvbnN0IGxvZ2dlZFVzZXIgPSBhd2FpdCBnZXRMb2dnZWRVc2VyKHJlcSk7XG5cblx0Y29uc3Qgcm9sZSA9IChsb2dnZWRVc2VyID09IHVuZGVmaW5lZCk/IDAgOiBsb2dnZWRVc2VyLnJvbGU7XG5cblx0cmVzLnJlbmRlcigncGFnZXMvbWFpbicsIHtcblx0XHRyb2xlXG5cdH0pO1xufSk7XG5hcHAuZ2V0KCcvbG9naW4nLCAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRyZXMucmVuZGVyKCdwYWdlcy9sb2dpbicpO1xufSk7XG5hcHAuZ2V0KCcvcHJpdi1leGVjL2xpc3QnLCBhc3luYyAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCBsb2dnZWRVc2VyID0gYXdhaXQgZ2V0TG9nZ2VkVXNlcihyZXEpO1xuXG5cdGlmKGxvZ2dlZFVzZXIgPT0gdW5kZWZpbmVkKSByZXR1cm4gcmVzLnJlZGlyZWN0KCcvZXJyb3IvcGVybWlzc2lvbi1kZW5pZWQnKTtcblxuXHQvL3Jlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCdwdWJsaWMvaW5kZXguaHRtbCcpKTtcbn0pO1xuYXBwLmdldCgnL3JlZ2lzdHJhdG9yL2xpc3QnLCBhc3luYyAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCBsb2dnZWRVc2VyID0gYXdhaXQgZ2V0TG9nZ2VkVXNlcihyZXEpO1xuXG5cdGlmKGxvZ2dlZFVzZXIgPT0gdW5kZWZpbmVkKSByZXR1cm4gcmVzLnJlZGlyZWN0KCcvZXJyb3IvcGVybWlzc2lvbi1kZW5pZWQnKTtcblxuXHQvL3Jlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCdwdWJsaWMvaW5kZXguaHRtbCcpKTtcbn0pO1xuYXBwLmdldCgnL2V2ZW50LWpvdXJuYWwnLCBhc3luYyAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCBsb2dnZWRVc2VyID0gYXdhaXQgZ2V0TG9nZ2VkVXNlcihyZXEpO1xuXG5cdGlmKGxvZ2dlZFVzZXIgPT0gdW5kZWZpbmVkKSByZXR1cm4gcmVzLnJlZGlyZWN0KCcvZXJyb3IvcGVybWlzc2lvbi1kZW5pZWQnKTtcblxuXHQvL3Jlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCdwdWJsaWMvaW5kZXguaHRtbCcpKTtcbn0pO1xuYXBwLmdldCgnL3ByaXYtZXhlYy9uZXcnLCBhc3luYyAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCBsb2dnZWRVc2VyID0gYXdhaXQgZ2V0TG9nZ2VkVXNlcihyZXEpO1xuXG5cdGlmKGxvZ2dlZFVzZXIgPT0gdW5kZWZpbmVkKSByZXR1cm4gcmVzLnJlZGlyZWN0KCcvZXJyb3IvcGVybWlzc2lvbi1kZW5pZWQnKTtcblxuXHQvL3Jlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCdwdWJsaWMvaW5kZXguaHRtbCcpKTtcbn0pO1xuYXBwLmdldCgnL3ByaXYtZXhlYy9lZGl0JywgYXN5bmMgKHJlcTogYW55LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcblx0Y29uc3QgbG9nZ2VkVXNlciA9IGF3YWl0IGdldExvZ2dlZFVzZXIocmVxKTtcblxuXHRpZihsb2dnZWRVc2VyID09IHVuZGVmaW5lZCkgcmV0dXJuIHJlcy5yZWRpcmVjdCgnL2Vycm9yL3Blcm1pc3Npb24tZGVuaWVkJyk7XG5cblx0Ly9yZXMuc2VuZEZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwncHVibGljL2luZGV4Lmh0bWwnKSk7XG59KTtcbmFwcC5nZXQoJy9yZWdpc3RyYXRvci9uZXcnLCBhc3luYyAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCBsb2dnZWRVc2VyID0gYXdhaXQgZ2V0TG9nZ2VkVXNlcihyZXEpO1xuXG5cdGlmKGxvZ2dlZFVzZXIgPT0gdW5kZWZpbmVkKSByZXR1cm4gcmVzLnJlZGlyZWN0KCcvZXJyb3IvcGVybWlzc2lvbi1kZW5pZWQnKTtcblxuXHQvL3Jlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCdwdWJsaWMvaW5kZXguaHRtbCcpKTtcbn0pO1xuYXBwLmdldCgnL3JlZ2lzdHJhdG9yL2VkaXQnLCBhc3luYyAocmVxOiBhbnksIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCBsb2dnZWRVc2VyID0gYXdhaXQgZ2V0TG9nZ2VkVXNlcihyZXEpO1xuXG5cdGlmKGxvZ2dlZFVzZXIgPT0gdW5kZWZpbmVkKSByZXR1cm4gcmVzLnJlZGlyZWN0KCcvZXJyb3IvcGVybWlzc2lvbi1kZW5pZWQnKTtcblxuXHQvL3Jlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCdwdWJsaWMvaW5kZXguaHRtbCcpKTtcbn0pO1xuYXBwLmdldCgnL2Vycm9yL3Blcm1pc3Npb24tZGVuaWVkJywgYXN5bmMgKHJlcTogYW55LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcblx0Ly9yZXMuc2VuZEZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwncHVibGljL2luZGV4Lmh0bWwnKSk7XG59KTtcblxuXG5hcHAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJywgYXN5bmMgKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcblx0Y29uc3QgeyBsb2dpbiwgcGFzc3dvcmQgfSA9IHJlcS5ib2R5O1xuXG5cdGNvbnN0IHVzZXJEYXRhID0gYXdhaXQgVXNlci5maW5kT25lKGxvZ2luKTtcblxuXHRpZih1c2VyRGF0YS5wd2RfaGFzaCA9PT0gcGFzc3dvcmQgJiYgdXNlckRhdGEuaXNfYWN0aXZlID09PSB0cnVlKXtcblx0XHRyZXMuY29va2llKGNvb2tpZU5hbWUsIEpTT04uc3RyaW5naWZ5KHtsb2dpbiwgcGFzc3dvcmR9KSwgY29va2llT3B0aW9ucyk7XG5cblx0ICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCk7XG5cdH1lbHNle1xuXHRcdHJlcy5zdGF0dXMoNDAwKS5zZW5kKCk7XG5cdH1cbn0pO1xuYXBwLnBvc3QoJy9hcGkvYXV0aC9sb2dvdXQnLCBhc3luYyAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRyZXMuY2xlYXJDb29raWUoY29va2llTmFtZSwgY29va2llT3B0aW9ucyk7XG5cblx0cmVzLnN0YXR1cygyMDApLnNlbmQoKTtcbn0pO1xuXG5cbmFwcC5wb3N0KCcvYXBpL3VzZXInLCBhc3luYyAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCB7IGZ1bGxuYW1lLCBhZGRpdGlvbmFsX2RhdGEgfSA9IHJlcS5ib2R5O1xuXG5cdGNvbnN0IGlkZW50aWZpY2F0aW9uRGF0YSA9IHtcblx0XHRsb2dpbjogdXVpZFYxKCksXG5cdFx0cGFzc3dvcmQ6IHV1aWRWNCgpXG5cdH07XG5cblx0aWYoYXdhaXQgVXNlci5maW5kT25lKHsgZnVsbG5hbWUgfSkgPT0gdW5kZWZpbmVkKXtcblx0XHRjb25zdCB1c2VyID0gbmV3IFVzZXIoKTtcblxuXHRcdHVzZXIubG9naW4gPSBpZGVudGlmaWNhdGlvbkRhdGEubG9naW47XG5cdFx0dXNlci5wd2RfaGFzaCA9IGlkZW50aWZpY2F0aW9uRGF0YS5wYXNzd29yZDtcblx0XHR1c2VyLmZ1bGxuYW1lID0gZnVsbG5hbWU7XG5cdFx0dXNlci5yb2xlID0gMTtcblx0XHR1c2VyLmRhdGVfcmVnaXN0cmF0aW9uID0gKG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCk7XG5cdFx0dXNlci5pc19hY3RpdmUgPSB0cnVlO1xuXHRcdHVzZXIuYWRkaXRpb25hbF9kYXRhID0gYWRkaXRpb25hbF9kYXRhO1xuXHRcdFxuXHRcdGF3YWl0IHVzZXIuc2F2ZSgpO1xuXG5cdCAgICByZXMuanNvbihpZGVudGlmaWNhdGlvbkRhdGEpO1xuXHR9ZWxzZXtcblx0XHRyZXMuc3RhdHVzKDQwMCkuc2VuZCgpO1xuXHR9XG59KTtcbmFwcC5wb3N0KCcvYXBpL3VzZXIvOmxvZ2luL3Jlc19pZCcsIGFzeW5jIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG5cdGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPbmUocmVxLnBhcmFtcy5sb2dpbik7XG5cblx0aWYodXNlciA9PSB1bmRlZmluZWQpe1xuXHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgpO1xuXHR9XG5cblx0dXNlci5sb2dpbiA9IHV1aWRWMSgpO1xuXHR1c2VyLnB3ZF9oYXNoID0gdXVpZFY0KCk7XG5cdFxuXHRhd2FpdCB1c2VyLnNhdmUoKTtcblxuICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCk7XG59KTtcbmFwcC5wdXQoJy9hcGkvdXNlci86bG9naW4nLCBhc3luYyAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRjb25zdCB7IGZ1bGxuYW1lLCBhZGRpdGlvbmFsX2RhdGEsIGlzX2FjdGl2ZSB9ID0gcmVxLmJvZHk7XG5cblx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZShyZXEucGFyYW1zLmxvZ2luKTtcblxuXHRpZih1c2VyID09IHVuZGVmaW5lZCl7XG5cdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCk7XG5cdH1cblxuXHRpZihmdWxsbmFtZSAhPSB1bmRlZmluZWQpIHVzZXIuZnVsbG5hbWUgPSBmdWxsbmFtZTtcblx0aWYoaXNfYWN0aXZlICE9IHVuZGVmaW5lZCkgdXNlci5pc19hY3RpdmUgPSBpc19hY3RpdmU7XG5cdGlmKGFkZGl0aW9uYWxfZGF0YSAhPSB1bmRlZmluZWQpIHVzZXIuYWRkaXRpb25hbF9kYXRhID0gYWRkaXRpb25hbF9kYXRhO1xuXHRcblx0YXdhaXQgdXNlci5zYXZlKCk7XG5cbiAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCgpO1xufSk7XG5hcHAuZGVsZXRlKCcvYXBpL3VzZXIvOmxvZ2luJywgYXN5bmMgKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcblx0YXdhaXQgVXNlci5yZW1vdmUocmVxLnBhcmFtcy5sb2dpbik7XG5cbiAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCgpO1xufSk7XG5cblxuYXBwLnBvc3QoJy9hcGkvcHJpdi1leGVjJywgYXN5bmMgKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcblx0Y29uc3QgeyBcblx0XHRmdWxsbmFtZSwgZGlzdHJpY3RfaWQsIGNlcnRpZmljYXRlX251bSxcblx0XHRyZWNfY2VydGlmX29uLCBvZmZpY2VfYWRkciwgc3RhcnRlZF9vdXRfb25cblx0fSA9IHJlcS5ib2R5O1xuXHRjb25zdCB1c2VyX2xvZ2luID0gSlNPTi5wYXJzZShyZXEuc2lnbmVkQ29va2llc1tjb29raWVOYW1lXSkubG9naW47XG5cblx0aWYoYXdhaXQgUHJpdmF0ZUV4ZWN1dG9yLmZpbmRPbmUoeyBmdWxsbmFtZSB9KSA9PSB1bmRlZmluZWQpe1xuXHRcdGNvbnN0IHByaXZFeGVjID0gbmV3IFByaXZhdGVFeGVjdXRvcigpO1xuXG5cdFx0cHJpdkV4ZWMuZnVsbG5hbWUgPSBmdWxsbmFtZTtcblx0XHRwcml2RXhlYy51c2VyID0gYXdhaXQgVXNlci5maW5kT25lKHVzZXJfbG9naW4pO1xuXHRcdHByaXZFeGVjLmRpc3RyaWN0ID0gYXdhaXQgRXhlY3V0aW9uRGlzdHJpY3QuZmluZE9uZShkaXN0cmljdF9pZCk7XG5cdFx0cHJpdkV4ZWMuaXNfYWN0aXZlID0gdHJ1ZTtcblx0XHRwcml2RXhlYy5jcmVhdGVkX29uID0gKG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCk7XG5cdFx0cHJpdkV4ZWMuY2VydGlmaWNhdGVfbnVtID0gY2VydGlmaWNhdGVfbnVtO1xuXHRcdHByaXZFeGVjLnJlY19jZXJ0aWZfb24gPSByZWNfY2VydGlmX29uO1xuXHRcdHByaXZFeGVjLm9mZmljZV9hZGRyID0gb2ZmaWNlX2FkZHI7XG5cdFx0cHJpdkV4ZWMuc3RhcnRlZF9vdXRfb24gPSBzdGFydGVkX291dF9vbjtcblx0XHRcblx0XHRhd2FpdCBwcml2RXhlYy5zYXZlKCk7XG5cblx0ICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCk7XG5cdH1lbHNle1xuXHRcdHJlcy5zdGF0dXMoNDAwKS5zZW5kKCk7XG5cdH1cbn0pO1xuYXBwLnB1dCgnL2FwaS9wcml2LWV4ZWMvOmlkJywgYXN5bmMgKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpID0+IHtcblx0Y29uc3QgeyBcblx0XHRmdWxsbmFtZSwgZGlzdHJpY3RfaWQsIGNlcnRpZmljYXRlX251bSxcblx0XHRyZWNfY2VydGlmX29uLCBvZmZpY2VfYWRkciwgc3RhcnRlZF9vdXRfb24sXG5cdFx0aXNfYWN0aXZlXG5cdH0gPSByZXEuYm9keTtcblxuXHRjb25zdCBwcml2RXhlYyA9IGF3YWl0IFByaXZhdGVFeGVjdXRvci5maW5kT25lKHJlcS5wYXJhbXMuaWQpO1xuXG5cdGlmKHByaXZFeGVjID09IHVuZGVmaW5lZCl7XG5cdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCk7XG5cdH1cblxuXHRpZihmdWxsbmFtZSAhPSB1bmRlZmluZWQpIHByaXZFeGVjLmZ1bGxuYW1lID0gZnVsbG5hbWU7XG5cdGlmKGRpc3RyaWN0X2lkICE9IHVuZGVmaW5lZCkgcHJpdkV4ZWMuZGlzdHJpY3QgPSBhd2FpdCBFeGVjdXRpb25EaXN0cmljdC5maW5kT25lKGRpc3RyaWN0X2lkKTtcblx0aWYoY2VydGlmaWNhdGVfbnVtICE9IHVuZGVmaW5lZCkgcHJpdkV4ZWMuY2VydGlmaWNhdGVfbnVtID0gY2VydGlmaWNhdGVfbnVtO1xuXHRpZihyZWNfY2VydGlmX29uICE9IHVuZGVmaW5lZCkgcHJpdkV4ZWMucmVjX2NlcnRpZl9vbiA9IHJlY19jZXJ0aWZfb247XG5cdGlmKG9mZmljZV9hZGRyICE9IHVuZGVmaW5lZCkgcHJpdkV4ZWMub2ZmaWNlX2FkZHIgPSBvZmZpY2VfYWRkcjtcblx0aWYoc3RhcnRlZF9vdXRfb24gIT0gdW5kZWZpbmVkKSBwcml2RXhlYy5zdGFydGVkX291dF9vbiA9IHN0YXJ0ZWRfb3V0X29uO1xuXHRpZihpc19hY3RpdmUgIT0gdW5kZWZpbmVkKSBwcml2RXhlYy5pc19hY3RpdmUgPSBpc19hY3RpdmU7XG5cdFxuXHRhd2FpdCBwcml2RXhlYy5zYXZlKCk7XG5cbiAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCgpO1xufSk7XG5hcHAuZGVsZXRlKCcvYXBpL3ByaXYtZXhlYy86aWQnLCBhc3luYyAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xuXHRhd2FpdCBQcml2YXRlRXhlY3V0b3IucmVtb3ZlKHJlcS5wYXJhbXMuaWQpO1xuXG4gICAgcmVzLnN0YXR1cygyMDApLnNlbmQoKTtcbn0pO1xuXG5cbmFwcC51c2UoKGVycjogRXJyb3IsIHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXNwOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBGdW5jdGlvbik9Pntcblx0Y29uc29sZS5sb2coZXJyKTtcblx0cmVzcC5zdGF0dXMoNTAwKS5zZW5kKCdFUlJPUicpO1xufSk7XG5cbnByb2Nlc3Mub24oJ1NJR0lOVCcsYXN5bmMgKCkgPT4gKGF3YWl0IGNvbm5lY3Rpb25Qcm9taXNlKS5jbG9zZSgpLnRoZW4oKCkgPT4gcHJvY2Vzcy5leGl0KCkpKTtcblxuKGFzeW5jIGZ1bmN0aW9uKCl7XG5cdGF3YWl0IChhd2FpdCBjb25uZWN0aW9uUHJvbWlzZSkuc3luY2hyb25pemUoKTtcblxuXHRhcHAubGlzdGVuKHByb2Nlc3MuZW52LlBPUlQgfHwgNTAwMCwgKCkgPT4ge1xuXHRcdGNvbnNvbGUubG9nKFwiU3RhcnRlZCBzZXJ2ZXIhXCIpO1xuXHR9KTtcbn0pKCk7Il19